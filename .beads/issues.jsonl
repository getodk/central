{"id":"central-044","title":"Verify docs/vg/vg-server/vg_implementation.md","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-27T13:15:38.808865+05:30","updated_at":"2025-12-27T13:23:50.14623+05:30","closed_at":"2025-12-27T13:23:50.14623+05:30","close_reason":"Verified: Implementation files exist."}
{"id":"central-1aq","title":"Verify docs/vg/vg-short-token-app-users.md","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-27T13:16:09.636176+05:30","updated_at":"2025-12-27T13:25:17.650443+05:30","closed_at":"2025-12-27T13:25:17.650443+05:30","close_reason":"Verified: Design doc matches implementation."}
{"id":"central-1e5","title":"POST /projects/:projectId/app-users/telemetry: include deviceId/appUserId + invalidated status","description":"Update telemetry POST response to include deviceId and appUserId, and return a status that indicates whether the bearer token has been invalidated (revoked/deactivated/expired).\n\nImplementation notes:\n- server/lib/resources/vg-telemetry.js: after recording telemetry, re-check bearer token via Sessions.getByBearerToken(token) and set status: ok|invalidated.\n- server/lib/domain/vg-telemetry.js: return deviceId alongside inserted id/received_at so resource can echo it back.\n- server/test/integration/api/vg-telemetry.js: assert new response fields/status.\n- server/docs/vg_api.md: document response schema.\n\nFollow-ups:\n- Run server integration tests once npm deps/network are available.\n- Ensure client-side callers handle new fields/status.","notes":"Implementation done (code + docs + debug scripts committed/pushed).\n\nLanded commits:\n- server: 482bf898 (VG: telemetry response includes invalidation status; tracks debug scripts; adds server/docs/vg_api.md)\n- central: 18642ee (Update: server submodule for telemetry response)\n\nRemaining:\n- Run server integration test once npm deps are installed (network-restricted in this environment).","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T09:50:01.579293+05:30","updated_at":"2025-12-29T10:16:37.708433+05:30","closed_at":"2025-12-29T10:16:37.708445+05:30","comments":[{"id":1,"issue_id":"central-1e5","author":"vivekgupta","text":"Updated POST /projects/:projectId/app-users/telemetry response schema:\n\n{\n  \"id\": 55,\n  \"appUserId\": 123,\n  \"deviceId\": \"device-1\",\n  \"dateTime\": \"2025-12-21T10:02:00.000Z\",\n  \"serverTime\": \"2025-12-21T10:02:00.500Z\",\n  \"status\": \"ok\"  // or \"invalidated\"\n}\n\nMeaning:\n- appUserId: actorId from the field_key session\n- deviceId: echoed from request payload\n- status=invalidated if bearer token no longer resolves via Sessions.getByBearerToken(token) after processing (revoked/deactivated/expired).","created_at":"2025-12-29T04:22:57Z"},{"id":2,"issue_id":"central-1e5","author":"vivekgupta","text":"Landed in git:\n- server commit: 482bf898 (VG: telemetry response includes invalidation status; also tracks debug scripts + adds server/docs/vg_api.md)\n- central commit (submodule pointer): 18642ee","created_at":"2025-12-29T04:34:29Z"},{"id":3,"issue_id":"central-1e5","author":"vivekgupta","text":"Integration tests run.  - `docker compose -f docker-compose.yml -f docker-compose.override.yml -f docker-compose.dev.yml --profile central exec service sh -lc 'cd /usr/odk \u0026\u0026 node -v \u0026\u0026  NODE_CONFIG_ENV=test BCRYPT=insecure npx --prefix server mocha test/integration/api/vg-telemetry.js' ` \n    ✔ should accept app-user telemetry and allow admin listing with filters and paging (477ms)\n    ✔ should reject non-UTC deviceDateTime (71ms)\n    ✔ should reject telemetry from non-app-user actors (38ms)\n\n  3 passing (2s)","created_at":"2025-12-29T04:46:29Z"}]}
{"id":"central-1gn","title":"Verify docs/vg/vg-server/archived_app_user_login_short_token_system.md","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-27T13:15:49.053468+05:30","updated_at":"2025-12-27T13:24:00.349299+05:30","closed_at":"2025-12-27T13:24:00.349299+05:30","close_reason":"Verified: Archive matches implementation."}
{"id":"central-33v","title":"Verify docs/vg/vg-server/summary_failing_tests.md","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-27T13:15:43.93024+05:30","updated_at":"2025-12-27T13:23:55.257665+05:30","closed_at":"2025-12-27T13:23:55.257665+05:30","close_reason":"Verified: Summary matches known state."}
{"id":"central-3gw","title":"Verify docs/vg/vg-server/vg_core_server_edits.md","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-27T13:16:04.482018+05:30","updated_at":"2025-12-27T13:25:12.547858+05:30","closed_at":"2025-12-27T13:25:12.547858+05:30","close_reason":"Verified: Core edit present in code."}
{"id":"central-3i6","title":"Verify docs/vg/vg-server/vg_settings.md","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-27T13:15:13.294886+05:30","updated_at":"2025-12-27T13:22:14.248877+05:30","closed_at":"2025-12-27T13:22:14.248877+05:30","close_reason":"Verified: Settings keys and defaults match code."}
{"id":"central-6fs","title":"Username missing from \"Show QR\" flow QR code","description":"The \"Show QR\" flow was not including the username in the generated QR code payload. This has been fixed by including the username in the general settings, so it's available when scanning the QR code in ODK Collect.\n\nFixes: client/90760f1942d37ca274f909a30150a69a79926083","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-27T11:07:14.673391+05:30","updated_at":"2025-12-27T11:36:51.696164+05:30","closed_at":"2025-12-27T11:36:51.696164+05:30","close_reason":"Fixed in client commit 90760f19: Add username to QR payload"}
{"id":"central-8vs","title":"Verify docs/vg/vg-client/vg_core_client_edits.md","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-27T13:16:19.915021+05:30","updated_at":"2025-12-27T13:25:42.587146+05:30","closed_at":"2025-12-27T13:25:42.587146+05:30","close_reason":"Verified: Client routes match doc."}
{"id":"central-a9m","title":"Verify docs/vg/vg-server/vg_tests.md","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-27T13:15:28.610535+05:30","updated_at":"2025-12-27T13:23:30.3435+05:30","closed_at":"2025-12-27T13:23:30.3435+05:30","close_reason":"Verified: Test files exist."}
{"id":"central-aqy","title":"Verify docs/vg/vg-server/archived_vg_ci_checklist_app_user_login.md","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-27T13:15:33.703871+05:30","updated_at":"2025-12-27T13:23:35.451906+05:30","closed_at":"2025-12-27T13:23:35.451906+05:30","close_reason":"Verified: Archive consistent."}
{"id":"central-bq9","title":"Verify docs/vg/vg-server/vg_api.md","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-27T13:15:59.36002+05:30","updated_at":"2025-12-27T13:24:10.548133+05:30","closed_at":"2025-12-27T13:24:10.548133+05:30","close_reason":"Verified: API doc verified in previous step."}
{"id":"central-fsp","title":"Verify docs/vg/qr-code-generation.md","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-27T13:16:30.171466+05:30","updated_at":"2025-12-27T13:25:52.798675+05:30","closed_at":"2025-12-27T13:25:52.798675+05:30","close_reason":"Verified: Matches verified client code."}
{"id":"central-h8n","title":"Verify docs/vg/vg_git_workflow.md","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-27T13:16:14.766388+05:30","updated_at":"2025-12-27T13:25:22.744109+05:30","closed_at":"2025-12-27T13:25:22.744109+05:30","close_reason":"Verified: Workflow matches observed branches."}
{"id":"central-i8u","title":"Verify docs/vg/vg-server/vg_installation.md","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-27T13:15:23.504527+05:30","updated_at":"2025-12-27T13:22:47.470206+05:30","closed_at":"2025-12-27T13:22:47.470206+05:30","close_reason":"Verified: Installation steps match SQL file."}
{"id":"central-imj","title":"Telemetry: accept and store app events (event jsonb)","description":"Extend app-user telemetry so clients can send discrete app events (queued offline and replayed later) via POST /projects/:projectId/app-users/telemetry.\n\nPayload (backwards compatible):\n- Existing telemetry fields unchanged.\n- Support either:\n  - Single event: \"event\": { ... }\n  - Batch: \"events\": [{ ... }, ...] (max 10)\n\nEvent schema:\n- Required:\n  - \"id\" (client-generated stable id; string)\n  - \"type\" (string)\n- Optional:\n  - \"occurredAt\" (ISO timestamp)\n  - \"details\" (object)\n  - Any additional metadata (stored as-is)\n\nIdempotency / dedupe:\n- Uniqueness key is (appUserId/actorId, deviceId, event.id).\n- Server uses UPSERT semantics on that key so offline replays/retries don’t create duplicates.\n\nAuth/actor resolution:\n- Server must persist actorId for all telemetry rows.\n- Server should accept telemetry even if the app-user session has been invalidated/revoked/expired (offline queue).\n- Resolution policy:\n  1) Prefer resolving actorId from bearer token (even if invalidated; use token-to-actor lookup).\n  2) If token cannot be resolved, require appUserId in request body and store under that actorId (record status as invalidated/unverified).\n\nStorage:\n- vg_app_user_telemetry.event: jsonb (raw event object)\n- Add vg_app_user_telemetry.client_event_id (text) to store event.id\n- Add unique index for (actorId, device_id, client_event_id) where client_event_id is not null\n- (Optional) add derived event_type column/index later if filtering is needed.\n\nChildren:\n- DB migrations for jsonb event + client_event_id + unique index\n- Server: validate/accept batch + persist w/ upsert\n- Admin listing/tests/docs: return event fields\n","acceptance_criteria":"- Backward compatible: existing telemetry payloads (no event) still accepted.\\n- Accept single event (event) and batch (events[]) with max 10 items.\\n- Each event requires client-generated id + non-empty type.\\n- Server stores one DB row per event (no array-in-row).\\n- Server resolves/stores actorId for every row (prefers bearer token; fallback to appUserId in body if token invalidated).\\n- Requests with invalidated/revoked/expired sessions are not rejected; response indicates invalidation.\\n- Dedupe/upsert by (actorId, deviceId, clientEventId).","status":"open","priority":2,"issue_type":"feature","created_at":"2025-12-29T09:58:05.852931+05:30","updated_at":"2025-12-29T19:05:52.073201+05:30"}
{"id":"central-imj.1","title":"DB: add event jsonb to vg_app_user_telemetry","description":"Add nullable jsonb column (event) to vg_app_user_telemetry, plus any needed indexes (optional: derived event_type text + index if we want filter/search). Ensure migration path matches how vg tables are managed in this fork (knex migration vs manual SQL docs).","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T09:59:30.544963+05:30","updated_at":"2025-12-29T10:32:42.670194+05:30","closed_at":"2025-12-29T10:32:42.670194+05:30","close_reason":"Implemented + applied migration: added nullable jsonb 'event' column to vg_app_user_telemetry","dependencies":[{"issue_id":"central-imj.1","depends_on_id":"central-imj","type":"parent-child","created_at":"2025-12-29T09:59:30.545786+05:30","created_by":"vivekgupta"}],"comments":[{"id":4,"issue_id":"central-imj.1","author":"vivekgupta","text":"EDITED -  server/docs/sql/vg_app_user_auth.sql\n\n-- App-user telemetry data (device metadata, location, timestamps).\nCREATE TABLE IF NOT EXISTS vg_app_user_telemetry (\n  id bigserial PRIMARY KEY,\n  \"actorId\" integer NOT NULL REFERENCES actors(id) ON DELETE CASCADE,\n  device_id text NOT NULL,\n  collect_version text NOT NULL,\n  device_date_time timestamptz NOT NULL,\n  received_at timestamptz NOT NULL DEFAULT now(),\n  **event jsonb NULL,**\n  location_lat double precision NULL,\n  location_lng double precision NULL,\n  location_altitude double precision NULL,\n  location_accuracy double precision NULL,\n  location_speed double precision NULL,\n  location_bearing double precision NULL,\n  location_provider text NULL\n);\nALTER TABLE IF EXISTS vg_app_user_telemetry\n  ADD COLUMN IF NOT EXISTS event jsonb; \n\nAPPLIED MIGRATION\n  RAN - `docker exec -i central-postgres14-1 psql -U odk -d odk \u003c server/docs/sql/vg_app_user_auth.sql`","created_at":"2025-12-29T04:58:23Z"}]}
{"id":"central-imj.2","title":"Server: accept/validate event payload and persist","description":"Implement server-side support for batched, idempotent app-event telemetry ingestion.\n\nRequest parsing:\n- Support either \"event\" (single object) or \"events\" (array).\n- Normalize to an array of events.\n- Enforce max batch size: 10.\n\nValidation (per event):\n- event must be an object.\n- event.id: required non-empty string (client-generated stable id).\n- event.type: required non-empty string.\n- Optional occurredAt: ISO timestamp string.\n- Enforce size limits (per-event + total request) to prevent oversized jsonb writes.\n\nActor resolution:\n- Always store an actorId for each telemetry row.\n- Resolve actorId from bearer token when possible.\n- If bearer token cannot be resolved because session is invalidated/revoked/expired, do NOT reject; instead require appUserId in body and store under that actorId (and return status=invalidated/unverified).\n\nPersistence:\n- Write one DB row per event.\n- Store raw event object in vg_app_user_telemetry.event.\n- Store event.id in vg_app_user_telemetry.client_event_id.\n- Insert using upsert logic keyed by (actorId, device_id, client_event_id).\n  - Decide DO UPDATE vs DO NOTHING; DO UPDATE recommended so retries can repair incomplete rows.\n\nResponse:\n- 200 OK\n- For batches: return an array of per-event results (at least clientEventId + stored row id + status).\n\nTests:\n- Batch of 2-3 events inserts multiple rows.\n- Replay (same client_event_id) does not duplicate (upsert works).\n- Invalidated token path still stores events when appUserId provided.\n","acceptance_criteria":"- Accepts both {event} and {events:[...]} (max 10).\\n- Validates event.id and event.type (non-empty strings) and enforces payload size limits.\\n- Persists one row per event with actorId, device_id, client_event_id, event jsonb.\\n- Uses upsert/dedupe on (actorId, device_id, client_event_id).\\n- Does not reject queued telemetry from invalidated/revoked/expired sessions; returns status to indicate invalidation.","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-29T09:59:40.90706+05:30","updated_at":"2025-12-29T19:06:16.378348+05:30","dependencies":[{"issue_id":"central-imj.2","depends_on_id":"central-imj","type":"parent-child","created_at":"2025-12-29T09:59:40.908128+05:30","created_by":"vivekgupta"},{"issue_id":"central-imj.2","depends_on_id":"central-imj.1","type":"blocks","created_at":"2025-12-29T10:00:05.061227+05:30","created_by":"vivekgupta"},{"issue_id":"central-imj.2","depends_on_id":"central-imj.4","type":"blocks","created_at":"2025-12-29T19:07:07.758838+05:30","created_by":"vivekgupta"}]}
{"id":"central-imj.3","title":"Admin listing/tests/docs: return event","description":"Update admin telemetry listing to return stored app events and related metadata.\n\nAPI:\n- Extend GET /system/app-users/telemetry to include:\n  - event (json)\n  - clientEventId (from client_event_id)\n  - (Optional) auth status indicating whether upload was from an invalidated session\n\nTests:\n- Ensure stored event is returned verbatim.\n- Ensure clientEventId is returned.\n\nDocs:\n- Update server/docs/vg_api.md with request/response examples for:\n  - single-event telemetry\n  - batched telemetry (max 10)\n  - dedupe/upsert semantics (idempotency key)\n","acceptance_criteria":"- Admin listing includes event jsonb and client_event_id for each telemetry row.\\n- (If implemented) listing includes auth status (ok/invalidated/unverified) so admins can understand queued uploads.\\n- Integration tests cover returning stored event + client_event_id.\\n- Docs updated (server/docs/vg_api.md and optionally api.yaml).","status":"open","priority":3,"issue_type":"task","created_at":"2025-12-29T09:59:51.241875+05:30","updated_at":"2025-12-29T19:06:34.331034+05:30","dependencies":[{"issue_id":"central-imj.3","depends_on_id":"central-imj","type":"parent-child","created_at":"2025-12-29T09:59:51.242762+05:30","created_by":"vivekgupta"},{"issue_id":"central-imj.3","depends_on_id":"central-imj.2","type":"blocks","created_at":"2025-12-29T10:00:15.329628+05:30","created_by":"vivekgupta"}]}
{"id":"central-imj.4","title":"DB: add client_event_id + unique index for telemetry idempotency","description":"Add columns/indexes needed for idempotent, batched telemetry events.\n\nChange:\n- Add nullable column: vg_app_user_telemetry.client_event_id text\n  - Stores client-generated event.id.\n- Add unique index to support UPSERT/dedupe:\n  - UNIQUE (\"actorId\", device_id, client_event_id) WHERE client_event_id IS NOT NULL\n\nNotes:\n- Keep backwards compatibility: existing rows without client_event_id remain valid.\n- Column/index should be added to:\n  - server/docs/sql/vg_app_user_auth.sql\n  - server/test/integration/fixtures/03-vg-app-user-auth.js\n","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-29T19:06:53.215113+05:30","created_by":"vivekgupta","updated_at":"2025-12-29T19:06:53.215113+05:30","dependencies":[{"issue_id":"central-imj.4","depends_on_id":"central-imj","type":"parent-child","created_at":"2025-12-29T19:06:53.216354+05:30","created_by":"vivekgupta"}]}
{"id":"central-jh0","title":"Verify docs/vg/vg-server/vg_overview.md","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-27T13:15:18.397079+05:30","updated_at":"2025-12-27T13:22:42.371834+05:30","closed_at":"2025-12-27T13:22:42.371834+05:30","close_reason":"Verified: Overview matches schema and defaults."}
{"id":"central-jpt","title":"Verify docs/vg/vg-server/vg_user_behavior.md","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-27T13:15:54.187387+05:30","updated_at":"2025-12-27T13:24:05.447486+05:30","closed_at":"2025-12-27T13:24:05.447486+05:30","close_reason":"Verified: Behavior matches API and code."}
{"id":"central-ore","title":"Central service startup hang - RCA needed","status":"closed","priority":0,"issue_type":"bug","created_at":"2025-12-27T23:55:18.056799+05:30","updated_at":"2025-12-27T23:59:02.665918+05:30","closed_at":"2025-12-27T23:59:02.665918+05:30","close_reason":"Resolved: Nginx stale DNS cache after service container restart. Fix: docker compose restart nginx"}
{"id":"central-qtg","title":"Show User device teleemtry on map","description":"I want to see the telemtry ifnormation ofopr each user deivce on a map. Each filter by device amd ate range. I am leaning towards use of leaf;et for map display","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-12-26T11:54:57.548518+05:30","updated_at":"2025-12-26T12:13:18.062787+05:30","closed_at":"2025-12-26T12:13:18.062787+05:30","close_reason":"Closed"}
{"id":"central-qyo","title":"Verify docs/vg/vg-server/archived_cmds.md","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-27T13:15:06.311766+05:30","updated_at":"2025-12-27T13:20:22.406253+05:30","closed_at":"2025-12-27T13:20:22.406253+05:30","close_reason":"Verified: Archived doc points to existing SQL file."}
{"id":"central-rai","title":"Add app user permission for GET /v1/projects/{id}","description":"Allow app user actors to access project details endpoint","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-28T00:01:05.309566+05:30","updated_at":"2025-12-28T00:13:10.9566+05:30","closed_at":"2025-12-28T00:13:10.9566+05:30","close_reason":"Implemented app user access to GET /v1/projects/:id. Modified projects.js to check if actor is field_key and belongs to project. Added getByActorId to field-keys.js. App users get basic data only (no extended metadata)."}
{"id":"central-thb","title":"Update docs/vg to match submodule changes","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-27T11:29:52.097983+05:30","updated_at":"2025-12-27T11:35:44.944526+05:30","closed_at":"2025-12-27T11:35:44.944526+05:30","close_reason":"Moved VG docs to central/docs/vg/ and updated submodules"}
{"id":"central-uls","title":"App Users Can Read Project Details via GET /v1/projects/{id}","description":"\n\n## Summary\nImplemented support for app users (field_keys) to read project details via the GET /v1/projects/{id} endpoint.\n\n## Implementation Details\n\n### Changes Made\n1. **server/docs/sql/vg_app_user_auth.sql**\n   - Added UPDATE statement to grant 'project.read' verb to app-user role\n   - Commit: 87a62efd\n\n2. **server/lib/model/query/auth.js** \n   - Added special authorization logic for field_keys (app users)\n   - App users can now read a project if they have assignment to any form in that project\n   - Maintains security by checking form-level assignments\n   - Commit: ebb671bd\n\n### How It Works\n- App users are field_keys in the system, not web users\n- They have assignments to forms, not projects\n- Added special case in can() function that checks:\n  1. Actor is a field_key\n  2. Requesting project.read permission\n  3. Has access to at least one form in the project via form assignments\n- This allows Collect app to fetch project metadata while maintaining security\n\n### Testing\n- App users can now call: GET /v1/projects/{id}\n- Returns project details (name, description, metadata)\n- Access is limited to projects they have form access to\n","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-12-27T23:33:19.74866+05:30","updated_at":"2025-12-29T09:49:43.232215+05:30","closed_at":"2025-12-29T09:49:43.232224+05:30"}
{"id":"central-uro","title":"Verify docs/vg/vg-client/vg_client_changes.md","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-27T13:16:25.041219+05:30","updated_at":"2025-12-27T13:25:47.689403+05:30","closed_at":"2025-12-27T13:25:47.689403+05:30","close_reason":"Verified: Recently updated summary."}
{"id":"central-xge","title":"Managed QR code payload exceeds capacity and causes truncation","description":"The payload for managed QR codes was too large, exceeding QR code capacity and causing data truncation. The payload has been optimized by removing unnecessary settings and simplifying others to ensure it fits.\n\nFixes: client/0e707d61f7bcd2b002b1595d745fc8a943a55b59","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-27T11:07:23.654973+05:30","updated_at":"2025-12-27T11:36:46.527573+05:30","closed_at":"2025-12-27T11:36:46.527573+05:30","close_reason":"Fixed in client commit 0e707d61: Optimize Managed QR payload"}
